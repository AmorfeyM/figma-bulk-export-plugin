<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–≠–∫—Å–ø–æ—Ä—Ç –ø–æ —Å–µ–∫—Ü–∏—è–º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 13px;
      line-height: 1.4;
      background: #2c2c2c;
      color: #ffffff;
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 16px;
    }

    .header {
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid #404040;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
    }

    .sections-info {
      background: #383838;
      border-radius: 6px;
      padding: 12px;
      border: 1px solid #404040;
    }

    .sections-count {
      font-weight: 500;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .sections-list {
      max-height: 120px;
      overflow-y: auto;
    }

    .section-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 12px;
      color: #cccccc;
    }

    .settings {
      background: #383838;
      border-radius: 6px;
      padding: 12px;
      border: 1px solid #404040;
    }

    .setting-group {
      margin-bottom: 12px;
    }

    .setting-group:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #ffffff;
    }

    .setting-select, .setting-input {
      width: 100%;
      padding: 6px 8px;
      background: #2c2c2c;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #ffffff;
      font-size: 12px;
    }

    .setting-select:focus, .setting-input:focus {
      outline: none;
      border-color: #0d99ff;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox {
      width: 16px;
      height: 16px;
    }

    .progress-section {
      background: #383838;
      border-radius: 6px;
      padding: 12px;
      border: 1px solid #404040;
      display: none;
    }

    .progress-section.visible {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #2c2c2c;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0d99ff, #00d4ff);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .progress-details {
      font-size: 11px;
      color: #cccccc;
      text-align: center;
    }

    .buttons {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .button-primary {
      background: #0d99ff;
      color: #ffffff;
    }

    .button-primary:hover:not(:disabled) {
      background: #0086e6;
    }

    .button-primary:disabled {
      background: #404040;
      color: #808080;
      cursor: not-allowed;
    }

    .button-secondary {
      background: #404040;
      color: #ffffff;
    }

    .button-secondary:hover:not(:disabled) {
      background: #4a4a4a;
    }

    .button-download {
      background: #28a745;
      color: #ffffff;
      display: none;
    }

    .button-download.visible {
      display: block;
    }

    .button-download:hover {
      background: #218838;
    }

    .error-message {
      background: #dc3545;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    .success-message {
      background: #28a745;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }

    .success-message.visible {
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ */
    .auth-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #2c2c2c;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 16px;
      z-index: 1000;
    }

    .auth-screen.hidden {
      display: none;
    }

    .auth-card {
      background: #383838;
      border-radius: 8px;
      padding: 24px;
      border: 1px solid #404040;
      text-align: center;
      max-width: 320px;
      width: 100%;
    }

    .auth-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .auth-subtitle {
      font-size: 13px;
      color: #cccccc;
      margin-bottom: 24px;
      line-height: 1.4;
    }

    .auth-input {
      width: 100%;
      padding: 12px;
      background: #2c2c2c;
      border: 1px solid #404040;
      border-radius: 6px;
      color: #ffffff;
      font-size: 14px;
      text-align: center;
      margin-bottom: 12px;
      font-family: inherit;
    }

    .auth-input:focus {
      outline: none;
      border-color: #0d99ff;
      box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.2);
    }

    .auth-input::placeholder {
      color: #808080;
      font-family: inherit;
    }

    .auth-button {
      width: 100%;
      padding: 12px;
      background: #0d99ff;
      border: none;
      border-radius: 6px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .auth-button:hover:not(:disabled) {
      background: #0086e6;
    }

    .auth-button:disabled {
      background: #404040;
      color: #808080;
      cursor: not-allowed;
    }

    .auth-error {
      background: #dc3545;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 12px;
      display: none;
    }

    .auth-error.visible {
      display: block;
    }

    .subscription-info {
      margin-top: 12px;
      padding: 12px;
      background: #2c2c2c;
      border-radius: 6px;
      border: 1px solid #404040;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ -->
  <div class="auth-screen" id="subscriptionScreen">
    <div class="auth-card">
      <h2 class="auth-title">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–ª–∞–≥–∏–Ω</h2>
      <p class="auth-subtitle">–í–≤–µ–¥–∏—Ç–µ email –∏ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏</p>

      <input
        type="email"
        class="auth-input"
        id="emailInput"
        placeholder="your@email.com"
        style="margin-bottom: 8px;"
      >

      <input
        type="text"
        class="auth-input"
        id="licenseKeyInput"
        placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á"
        style="margin-bottom: 12px;"
      >

      <button class="auth-button" id="subscriptionButton">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>

      <div style="text-align: center; margin: 16px 0; color: #808080; font-size: 12px;">
        –∏–ª–∏
      </div>

      <button class="auth-button" id="buySubscriptionButton" style="background: #28a745; margin-bottom: 12px;">
        –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
      </button>

      <div class="subscription-plans" id="subscriptionPlans" style="display: none; margin-bottom: 12px;">
        <select class="auth-input" id="planSelect" style="margin-bottom: 8px;">
          <option value="monthly">–ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 500‚ÇΩ</option>
          <option value="quarterly">–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 1200‚ÇΩ</option>
          <option value="yearly">–ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 4000‚ÇΩ</option>
        </select>
        <button class="auth-button" id="proceedPaymentButton">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
      </div>

      <div class="auth-error" id="subscriptionError"></div>

      <div class="subscription-info" id="subscriptionInfo" style="display: none;">
        <p id="subscriptionStatus" style="font-size: 12px; color: #28a745; text-align: center; margin-bottom: 4px;"></p>
        <p id="subscriptionExpires" style="font-size: 11px; color: #cccccc; text-align: center;"></p>
      </div>

      <div style="text-align: center; margin-top: 16px; font-size: 10px; color: #808080;">
        <p>üí≥ –ü—Ä–∏–Ω–∏–º–∞–µ–º –∫–∞—Ä—Ç—ã —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –±–∞–Ω–∫–æ–≤</p>
        <p>üîí –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆKassa</p>
      </div>
    </div>
  </div>

  <div class="container" id="mainContainer">
    <div class="header">
      <h1>–≠–∫—Å–ø–æ—Ä—Ç –ø–æ —Å–µ–∫—Ü–∏—è–º</h1>
    </div>

    <div class="sections-info" id="sectionsInfo">
      <div class="sections-count" id="sectionsCount">–ü–æ–∏—Å–∫ —Å–µ–∫—Ü–∏–π...</div>
      <div class="sections-list" id="sectionsList"></div>
    </div>

    <div class="settings">
      <div class="setting-group">
        <label class="setting-label" for="formatSelect">–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:</label>
        <select class="setting-select" id="formatSelect">
          <option value="PNG">PNG</option>
          <option value="JPG">JPG</option>
          <option value="SVG">SVG</option>
        </select>
      </div>

      <div class="setting-group">
        <label class="setting-label" for="scaleInput">–ú–∞—Å—à—Ç–∞–±:</label>
        <select class="setting-select" id="scaleInput">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>

      <div class="setting-group">
        <div class="checkbox-group">
          <input type="checkbox" class="checkbox" id="createZipCheck" checked>
          <label class="setting-label" for="createZipCheck">–°–æ–∑–¥–∞—Ç—å ZIP –∞—Ä—Ö–∏–≤</label>
        </div>
      </div>
    </div>

    <div class="progress-section" id="progressSection">
      <div class="progress-text" id="progressText">0%</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-details" id="progressDetails">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É...</div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="buttons">
      <button class="button button-primary" id="exportBtn">–ù–∞—á–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç</button>
      <button class="button button-download" id="downloadBtn">–°–∫–∞—á–∞—Ç—å ZIP</button>
      <button class="button button-secondary" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ CDN –¥–ª—è JSZip
    const JSZip_CDNS = [
      'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js',
      'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'
    ];

    let currentCDNIndex = 0;
    let JSZipLoaded = false;
    let sectionsData = [];
    let exportedData = null;
    let isExporting = false;
    let hasActiveSubscription = false;

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ JSZip —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ CDN
    function loadJSZip() {
      return new Promise((resolve, reject) => {
        if (window.JSZip) {
          JSZipLoaded = true;
          resolve(window.JSZip);
          return;
        }

        function tryLoadFromCDN(index) {
          if (index >= JSZip_CDNS.length) {
            JSZipLoaded = false;
            reject(new Error('–í—Å–µ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'));
            return;
          }

          const script = document.createElement('script');
          script.src = JSZip_CDNS[index];

          script.onload = () => {
            if (window.JSZip) {
              JSZipLoaded = true;
              console.log(`JSZip –∑–∞–≥—Ä—É–∂–µ–Ω —Å CDN ${index + 1}: ${JSZip_CDNS[index]}`);
              resolve(window.JSZip);
            } else {
              tryLoadFromCDN(index + 1);
            }
          };

          script.onerror = () => {
            console.warn(`CDN ${index + 1} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${JSZip_CDNS[index]}`);
            tryLoadFromCDN(index + 1);
          };

          document.head.appendChild(script);
        }

        tryLoadFromCDN(0);
      });
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const subscriptionScreen = document.getElementById('subscriptionScreen');
    const mainContainer = document.getElementById('mainContainer');
    const emailInput = document.getElementById('emailInput');
    const licenseKeyInput = document.getElementById('licenseKeyInput');
    const subscriptionButton = document.getElementById('subscriptionButton');
    const subscriptionError = document.getElementById('subscriptionError');
    const subscriptionInfo = document.getElementById('subscriptionInfo');
    const subscriptionStatus = document.getElementById('subscriptionStatus');
    const subscriptionExpires = document.getElementById('subscriptionExpires');
    const sectionsCount = document.getElementById('sectionsCount');
    const sectionsList = document.getElementById('sectionsList');
    const progressSection = document.getElementById('progressSection');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const progressDetails = document.getElementById('progressDetails');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const exportBtn = document.getElementById('exportBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const closeBtn = document.getElementById('closeBtn');
    const formatSelect = document.getElementById('formatSelect');
    const scaleInput = document.getElementById('scaleInput');
    const createZipCheck = document.getElementById('createZipCheck');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('visible');
      setTimeout(() => {
        errorMessage.classList.remove('visible');
      }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('visible');
      setTimeout(() => {
        successMessage.classList.remove('visible');
      }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    function showSubscriptionError(message) {
      subscriptionError.textContent = message;
      subscriptionError.classList.add('visible');
      setTimeout(() => {
        subscriptionError.classList.remove('visible');
      }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    function showSubscriptionScreen() {
      subscriptionScreen.classList.remove('hidden');
      mainContainer.style.display = 'none';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    function hideSubscriptionScreen() {
      subscriptionScreen.classList.add('hidden');
      mainContainer.style.display = 'flex';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email
    function validateEmail(email) {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailPattern.test(email);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ
    function showSubscriptionInfo(email, expires, offline = false) {
      subscriptionInfo.style.display = 'block';
      subscriptionStatus.textContent = `–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è ${email}`;

      if (expires) {
        const expiresDate = new Date(expires);
        const now = new Date();
        const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));

        if (daysLeft > 0) {
          subscriptionExpires.textContent = `–ò—Å—Ç–µ–∫–∞–µ—Ç: ${expiresDate.toLocaleDateString()} (–æ—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω–µ–π)`;
          subscriptionExpires.style.color = daysLeft > 7 ? '#28a745' : '#ffc107';
        } else {
          subscriptionExpires.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞';
          subscriptionExpires.style.color = '#dc3545';
        }
      }

      if (offline) {
        subscriptionExpires.textContent += ' (–æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º)';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    function verifySubscription() {
      const email = emailInput.value.trim().toLowerCase();
      const licenseKey = licenseKeyInput.value.trim();

      if (!email) {
        showSubscriptionError('–í–≤–µ–¥–∏—Ç–µ email');
        return;
      }

      if (!validateEmail(email)) {
        showSubscriptionError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
      }

      if (!licenseKey) {
        showSubscriptionError('–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á');
        return;
      }

      subscriptionButton.disabled = true;
      subscriptionButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏...';

      parent.postMessage({
        pluginMessage: {
          type: 'subscription-verify',
          email: email,
          license_key: licenseKey
        }
      }, '*');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function updateProgress(progress, details) {
      progressText.textContent = `${progress}%`;
      progressFill.style.width = `${progress}%`;
      progressDetails.textContent = details;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ–∫—Ü–∏–π
    function updateSectionsList(sections) {
      sectionsData = sections;

      if (sections.length === 0) {
        sectionsCount.textContent = '–°–µ–∫—Ü–∏–∏ —Å —Ñ—Ä–µ–π–º–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        sectionsList.innerHTML = '<div class="section-item">–°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ü–∏–∏ –≤ Figma –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∏—Ö —Ñ—Ä–µ–π–º—ã</div>';
        exportBtn.disabled = true;
        return;
      }

      const totalFrames = sections.reduce((sum, section) => sum + section.frameCount, 0);
      sectionsCount.textContent = `–ù–∞–π–¥–µ–Ω–æ —Å–µ–∫—Ü–∏–π: ${sections.length} (${totalFrames} —Ñ—Ä–µ–π–º–æ–≤)`;

      sectionsList.innerHTML = sections.map(section =>
        `<div class="section-item">
          <span>${section.name}</span>
          <span>${section.frameCount} —Ñ—Ä–µ–π–º–æ–≤</span>
        </div>`
      ).join('');

      exportBtn.disabled = false;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ZIP
    async function createAndDownloadZip(data) {
      try {
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å JSZip –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        if (!JSZipLoaded) {
          updateProgress(85, '–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ZIP...');
          await loadJSZip();
        }

        if (!window.JSZip) {
          throw new Error('JSZip –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        const zip = new JSZip();
        const format = formatSelect.value.toLowerCase();

        updateProgress(90, '–°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞...');

        for (const [sectionName, frames] of Object.entries(data)) {
          const sectionFolder = zip.folder(sectionName);

          for (const [frameName, imageBytes] of Object.entries(frames)) {
            const fileName = `${frameName}.${format}`;
            sectionFolder.file(fileName, imageBytes);
          }
        }

        updateProgress(95, '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä—Ö–∏–≤–∞...');

        const zipBlob = await zip.generateAsync({
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: {
            level: 6
          }
        });

        updateProgress(99, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é...');

        const url = URL.createObjectURL(zipBlob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `figma-export-${new Date().toISOString().slice(0, 10)}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        updateProgress(100, 'ZIP —Å–∫–∞—á–∞–Ω!');
        showSuccess('ZIP –∞—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!');

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ZIP:', error);
        showError(`JSZip –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏...`);
        downloadFilesIndividually(data);
      }
    }

    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–∫–∞—á–∏–≤–∞–Ω–∏—è - –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
    function downloadFilesIndividually(data) {
      try {
        const format = formatSelect.value.toLowerCase();
        let fileCount = 0;

        for (const [sectionName, frames] of Object.entries(data)) {
          for (const [frameName, imageBytes] of Object.entries(frames)) {
            setTimeout(() => {
              const blob = new Blob([imageBytes], { type: `image/${format}` });
              const url = URL.createObjectURL(blob);

              const a = document.createElement('a');
              a.href = url;
              a.download = `${sectionName}_${frameName}.${format}`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, fileCount * 200);

            fileCount++;
          }
        }

        showSuccess(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${fileCount} —Ñ–∞–π–ª–æ–≤ –Ω–∞—á–∞–ª–æ—Å—å`);
      } catch (error) {
        showError(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}`);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
    subscriptionButton.addEventListener('click', verifySubscription);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    const buySubscriptionButton = document.getElementById('buySubscriptionButton');
    const subscriptionPlans = document.getElementById('subscriptionPlans');
    const planSelect = document.getElementById('planSelect');
    const proceedPaymentButton = document.getElementById('proceedPaymentButton');

    buySubscriptionButton.addEventListener('click', () => {
      subscriptionPlans.style.display = subscriptionPlans.style.display === 'none' ? 'block' : 'none';
    });

    proceedPaymentButton.addEventListener('click', () => {
      const email = emailInput.value.trim().toLowerCase();
      const plan = planSelect.value;

      if (!email) {
        showSubscriptionError('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
        return;
      }

      if (!validateEmail(email)) {
        showSubscriptionError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
      }

      proceedPaymentButton.disabled = true;
      proceedPaymentButton.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...';

      parent.postMessage({
        pluginMessage: {
          type: 'create-payment',
          email: email,
          plan: plan
        }
      }, '*');
    });

    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        licenseKeyInput.focus();
      }
    });

    licenseKeyInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        verifySubscription();
      }
    });

    // –°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–ª—è –¥–µ–º–æ)
    let keySequence = [];
    document.addEventListener('keydown', (e) => {
      keySequence.push(e.key);
      if (keySequence.length > 5) keySequence.shift();

      // –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: R-E-S-E-T
      if (keySequence.join('').toUpperCase().includes('RESET')) {
        parent.postMessage({
          pluginMessage: { type: 'subscription-reset' }
        }, '*');
        keySequence = [];
        alert('üîÑ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞! –ü–ª–∞–≥–∏–Ω –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.');
        setTimeout(() => {
          parent.postMessage({
            pluginMessage: { type: 'subscription-check' }
          }, '*');
        }, 500);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    exportBtn.addEventListener('click', () => {
      if (isExporting) return;

      isExporting = true;
      exportBtn.disabled = true;
      progressSection.classList.add('visible');
      updateProgress(0, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É...');

      const settings = {
        format: formatSelect.value,
        scale: parseInt(scaleInput.value),
        createZip: createZipCheck.checked
      };

      parent.postMessage({
        pluginMessage: {
          type: 'start-export',
          settings: settings
        }
      }, '*');
    });

    downloadBtn.addEventListener('click', async () => {
      if (exportedData) {
        await createAndDownloadZip(exportedData);
      }
    });

    closeBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'close-plugin' }
      }, '*');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'subscription-status') {
        if (msg.active) {
          hasActiveSubscription = true;
          hideSubscriptionScreen();

          if (msg.email && msg.expires) {
            showSubscriptionInfo(msg.email, msg.expires);
          }

          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
          parent.postMessage({
            pluginMessage: { type: 'get-sections' }
          }, '*');
        } else {
          hasActiveSubscription = false;
          showSubscriptionScreen();
        }
        return;
      }

      if (msg.type === 'subscription-success') {
        hasActiveSubscription = true;
        subscriptionButton.disabled = false;
        subscriptionButton.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
        hideSubscriptionScreen();

        if (msg.offline) {
          showSuccess('–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º)');
        } else {
          showSuccess('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
        }

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        parent.postMessage({
          pluginMessage: { type: 'get-sections' }
        }, '*');
        return;
      }

      if (msg.type === 'subscription-error') {
        subscriptionButton.disabled = false;
        subscriptionButton.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
        showSubscriptionError(msg.message);

        if (msg.networkError) {
          subscriptionError.style.backgroundColor = '#ffc107';
          subscriptionError.style.color = '#000';
        }
        return;
      }

      if (msg.type === 'subscription-required') {
        showSubscriptionScreen();
        return;
      }

      if (msg.type === 'payment-created') {
        proceedPaymentButton.disabled = false;
        proceedPaymentButton.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ';

        if (msg.success) {
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º URL –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
          window.open(msg.payment_url, '_blank');
          showSubscriptionError(`–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω! –ó–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ. –°—É–º–º–∞: ${msg.amount.value} ${msg.amount.currency}`);
          subscriptionError.style.backgroundColor = '#28a745';
          subscriptionError.style.color = 'white';
        } else {
          showSubscriptionError(msg.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
        }
        return;
      }

      if (msg.type === 'sections-found') {
        updateSectionsList(msg.sections);
      }

      if (msg.type === 'export-progress') {
        updateProgress(msg.progress, `${msg.currentSection} - ${msg.currentFrame}`);
      }

      if (msg.type === 'export-complete') {
        exportedData = msg.data;
        isExporting = false;
        exportBtn.disabled = false;
        updateProgress(100, '–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!');

        if (createZipCheck.checked) {
          downloadBtn.classList.add('visible');
          showSuccess('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–°–∫–∞—á–∞—Ç—å ZIP".');
        } else {
          showSuccess('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!');
        }
      }

      if (msg.type === 'export-error') {
        isExporting = false;
        exportBtn.disabled = false;
        progressSection.classList.remove('visible');
        showError(msg.message);
      }
    };

    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JSZip –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    loadJSZip()
      .then(() => {
        console.log('‚úÖ JSZip –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        JSZipLoaded = true;
      })
      .catch(error => {
        console.warn('‚ö†Ô∏è JSZip –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å:', error.message);
        JSZipLoaded = false;
      });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
    window.resetSubscription = function() {
      parent.postMessage({
        pluginMessage: { type: 'subscription-reset' }
      }, '*');
      console.log('üîÑ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–ª–∞–≥–∏–Ω.');
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    parent.postMessage({
      pluginMessage: { type: 'subscription-check' }
    }, '*');

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    console.log('üîê Figma Bulk Export Plugin v2.0');
    console.log('üí° –î–ª—è —Å–±—Ä–æ—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–≤–µ–¥–∏—Ç–µ: resetSubscription()');
    console.log('üìß –ü–æ–¥–ø–∏—Å–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ÆKassa + Supabase');
  </script>
</body>
</html>
