<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–¥–ø–∏—Å–æ–∫ Figma Plugin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #5a6fd8;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-inactive {
            background: #e2e3e5;
            color: #383d41;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .hidden {
            display: none;
        }

        .license-key {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 12px;
        }

        .device-fingerprint {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-row {
                flex-direction: column;
            }

            input, select {
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div id="auth-section" class="auth-container">
        <div class="card">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <div class="form-group">
                <label for="admin-key">–ê–¥–º–∏–Ω-–∫–ª—é—á:</label>
                <input type="password" id="admin-key" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-–∫–ª—é—á">
            </div>
            <button onclick="authenticate()" style="width: 100%;">–í–æ–π—Ç–∏</button>
            <div id="auth-error" class="error hidden"></div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="container">
            <div class="header">
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–¥–ø–∏—Å–æ–∫</h1>
                <p class="subtitle">Figma Bulk Export Plugin - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</p>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats" id="stats-section">
                <div class="stat-card">
                    <div class="stat-number" id="total-subscriptions">-</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-subscriptions">-</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expired-subscriptions">-</div>
                    <div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthly-revenue">-</div>
                    <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
            </div>

            <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
            <div class="card">
                <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
                <div class="form-row">
                    <button onclick="testConnection()" class="secondary">–¢–µ—Å—Ç Supabase</button>
                    <button onclick="showConfig()" class="secondary">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>
                    <button onclick="generateTestLicense()" class="success">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç-–ª–∏—Ü–µ–Ω–∑–∏—é</button>
                </div>
                <div id="connection-result" class="hidden"></div>
            </div>

            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
            <div class="card">
                <h2>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é</h2>
                <div class="form-row">
                    <input type="email" id="new-email" placeholder="Email –∫–ª–∏–µ–Ω—Ç–∞">
                    <select id="new-plan">
                        <option value="monthly">–ú–µ—Å—è—á–Ω–∞—è (30 –¥–Ω–µ–π)</option>
                        <option value="quarterly">–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è (90 –¥–Ω–µ–π)</option>
                        <option value="yearly">–ì–æ–¥–æ–≤–∞—è (365 –¥–Ω–µ–π)</option>
                    </select>
                    <button onclick="createSubscription()" class="success">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                </div>
                <div id="create-result" class="hidden"></div>
            </div>

            <!-- –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
            <div class="card">
                <h2>–ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <div class="form-row">
                    <button onclick="exportSubscriptions()" class="secondary">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
                    <button onclick="cleanExpiredSubscriptions()" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–µ–∫—à–∏–µ</button>
                    <button onclick="sendNotifications()" class="secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>–°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫</h2>
                    <div>
                        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ email..." style="margin-right: 10px;">
                        <button onclick="loadSubscriptions()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>

                <div id="loading" class="loading hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div id="subscriptions-container">
                    <table id="subscriptions-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á</th>
                                <th>–ü–ª–∞–Ω</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°–æ–∑–¥–∞–Ω–∞</th>
                                <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptions-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ config.js –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let CONFIG = {
            SUPABASE_URL: 'https://your-project.supabase.co',
            SUPABASE_ANON_KEY: 'your_anon_key_here',
            ADMIN_KEY: 'admin-demo-key-change-this',
            DEMO_MODE: true
        };

        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ PLUGIN_CONFIG –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
        if (typeof PLUGIN_CONFIG !== 'undefined') {
            CONFIG = {
                SUPABASE_URL: PLUGIN_CONFIG.SUPABASE.URL,
                SUPABASE_ANON_KEY: PLUGIN_CONFIG.SUPABASE.ANON_KEY,
                ADMIN_KEY: PLUGIN_CONFIG.ADMIN.ACCESS_KEY,
                DEMO_MODE: PLUGIN_CONFIG.PLUGIN.DEMO_MODE
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function isConfigured() {
            return !CONFIG.SUPABASE_URL.includes('your-project') &&
                   !CONFIG.SUPABASE_ANON_KEY.includes('your_anon_key') &&
                   CONFIG.SUPABASE_URL.includes('.supabase.co');
        }

        let supabase = null
        let subscriptions = []
        let demoMode = false

        // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const DEMO_SUBSCRIPTIONS = [
            {
                id: 'demo-1',
                email: 'demo@example.com',
                license_key: 'DEMO-123456-ABCD',
                plan: 'monthly',
                status: 'active',
                created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                expires_at: new Date(Date.now() + 23 * 24 * 60 * 60 * 1000).toISOString(),
                device_fingerprint: 'demo-device-123'
            },
            {
                id: 'demo-2',
                email: 'test@company.com',
                license_key: 'TEST-789012-EFGH',
                plan: 'yearly',
                status: 'active',
                created_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                expires_at: new Date(Date.now() + 335 * 24 * 60 * 60 * 1000).toISOString(),
                device_fingerprint: null
            },
            {
                id: 'demo-3',
                email: 'expired@test.com',
                license_key: 'OLD-345678-IJKL',
                plan: 'monthly',
                status: 'active',
                created_at: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString(),
                expires_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                device_fingerprint: 'expired-device-456'
            }
        ]

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function authenticate() {
            const key = document.getElementById('admin-key').value
            const errorDiv = document.getElementById('auth-error')

            if (key === CONFIG.ADMIN_KEY) {
                document.getElementById('auth-section').classList.add('hidden')
                document.getElementById('admin-panel').classList.remove('hidden')

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Supabase
                if (isConfigured()) {
                    console.log('‚úÖ Supabase configured, using real data')
                    demoMode = false
                    supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY)
                } else {
                    console.log('‚ö†Ô∏è Supabase not configured, using demo mode')
                    demoMode = true

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ
                    const header = document.querySelector('.header')
                    const demoNotice = document.createElement('div')
                    demoNotice.style.cssText = 'background: #ffc107; color: #000; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px;'
                    demoNotice.innerHTML = '‚ö†Ô∏è <strong>–î–ï–ú–û-–†–ï–ñ–ò–ú</strong> - Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.'
                    header.appendChild(demoNotice)
                }

                loadSubscriptions()
                loadStats()
            } else {
                errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞'
                errorDiv.classList.remove('hidden')
                setTimeout(() => errorDiv.classList.add('hidden'), 3000)
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                let data;

                if (demoMode) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                    data = DEMO_SUBSCRIPTIONS;
                } else {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
                    const { data: supabaseData, error } = await supabase
                        .from('subscriptions')
                        .select('status, expires_at, created_at')

                    if (error) throw error
                    data = supabaseData;
                }

                const now = new Date()
                const total = data.length
                const active = data.filter(s => s.status === 'active' && new Date(s.expires_at) > now).length
                const expired = data.filter(s => new Date(s.expires_at) <= now).length

                document.getElementById('total-subscriptions').textContent = total
                document.getElementById('active-subscriptions').textContent = active
                document.getElementById('expired-subscriptions').textContent = expired

                // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö)
                document.getElementById('monthly-revenue').textContent = '‚ÇΩ' + (active * 500).toLocaleString()

            } catch (error) {
                console.error('Error loading stats:', error)

                // Fallback –∫ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (!demoMode) {
                    console.log('Falling back to demo data due to error')
                    demoMode = true
                    loadStats()
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
        async function loadSubscriptions() {
            const loading = document.getElementById('loading')
            loading.classList.remove('hidden')

            try {
                let data;

                if (demoMode) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                    console.log('Loading demo subscriptions data')
                    data = [...DEMO_SUBSCRIPTIONS].sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                } else {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
                    const { data: supabaseData, error } = await supabase
                        .from('subscriptions')
                        .select('*')
                        .order('created_at', { ascending: false })

                    if (error) throw error
                    data = supabaseData
                }

                subscriptions = data
                renderSubscriptions(data)

            } catch (error) {
                console.error('Error loading subscriptions:', error)

                // Fallback –∫ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (!demoMode) {
                    console.log('Falling back to demo data due to error')
                    demoMode = true
                    const demoData = [...DEMO_SUBSCRIPTIONS].sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    subscriptions = demoData
                    renderSubscriptions(demoData)
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message)
                }
            } finally {
                loading.classList.add('hidden')
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
        function renderSubscriptions(data) {
            const tbody = document.getElementById('subscriptions-list')
            tbody.innerHTML = ''

            data.forEach(sub => {
                const row = document.createElement('tr')
                const isExpired = new Date(sub.expires_at) < new Date()
                const isActive = sub.status === 'active' && !isExpired

                let statusClass = 'status-inactive'
                let statusText = sub.status

                if (isActive) {
                    statusClass = 'status-active'
                    statusText = '–ê–∫—Ç–∏–≤–Ω–∞'
                } else if (isExpired) {
                    statusClass = 'status-expired'
                    statusText = '–ò—Å—Ç–µ–∫–ª–∞'
                }

                row.innerHTML = `
                    <td>
                        <strong>${sub.email}</strong>
                    </td>
                    <td>
                        <span class="license-key">${sub.license_key}</span>
                    </td>
                    <td>${getPlanName(sub.plan)}</td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>${formatDate(sub.created_at)}</td>
                    <td>${formatDate(sub.expires_at)}</td>
                    <td>
                        ${sub.device_fingerprint ?
                            `<span class="device-fingerprint">${sub.device_fingerprint}</span>` :
                            '<em>–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</em>'
                        }
                    </td>
                    <td>
                        <button onclick="extendSubscription('${sub.id}')" class="success" title="–ü—Ä–æ–¥–ª–∏—Ç—å –Ω–∞ –º–µ—Å—è—Ü">+1–ú</button>
                        <button onclick="resetDevice('${sub.id}')" class="secondary" title="–°–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ">–°–±—Ä–æ—Å</button>
                        <button onclick="deactivateSubscription('${sub.id}')" class="danger" title="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å">‚úï</button>
                    </td>
                `
                tbody.appendChild(row)
            })
        }

        // –ü–æ–∏—Å–∫ –ø–æ–¥–ø–∏—Å–æ–∫
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase()
            const filtered = subscriptions.filter(sub =>
                sub.email.toLowerCase().includes(query) ||
                sub.license_key.toLowerCase().includes(query)
            )
            renderSubscriptions(filtered)
        })

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
        async function createSubscription() {
            const email = document.getElementById('new-email').value.trim()
            const plan = document.getElementById('new-plan').value
            const resultDiv = document.getElementById('create-result')

            if (!email) {
                showResult(resultDiv, '–í–≤–µ–¥–∏—Ç–µ email', 'error')
                return
            }

            if (!isValidEmail(email)) {
                showResult(resultDiv, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error')
                return
            }

            try {
                const expiresAt = new Date()
                if (plan === 'monthly') {
                    expiresAt.setMonth(expiresAt.getMonth() + 1)
                } else if (plan === 'quarterly') {
                    expiresAt.setMonth(expiresAt.getMonth() + 3)
                } else if (plan === 'yearly') {
                    expiresAt.setFullYear(expiresAt.getFullYear() + 1)
                }

                const licenseKey = generateLicenseKey()

                const { error } = await supabase
                    .from('subscriptions')
                    .insert({
                        email: email.toLowerCase(),
                        license_key: licenseKey,
                        plan: plan,
                        status: 'active',
                        expires_at: expiresAt.toISOString()
                    })

                if (error) throw error

                showResult(resultDiv, `
                    <strong>–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!</strong><br>
                    Email: ${email}<br>
                    –ö–ª—é—á: <span class="license-key">${licenseKey}</span><br>
                    –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${formatDate(expiresAt.toISOString())}
                `, 'success')

                document.getElementById('new-email').value = ''
                loadSubscriptions()
                loadStats()

            } catch (error) {
                showResult(resultDiv, '–û—à–∏–±–∫–∞: ' + error.message, 'error')
            }
        }

        // –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
        async function extendSubscription(id) {
            try {
                const { data: sub } = await supabase
                    .from('subscriptions')
                    .select('expires_at')
                    .eq('id', id)
                    .single()

                const currentExpiry = new Date(sub.expires_at)
                const newExpiry = new Date(currentExpiry)
                newExpiry.setMonth(newExpiry.getMonth() + 1)

                const { error } = await supabase
                    .from('subscriptions')
                    .update({
                        expires_at: newExpiry.toISOString(),
                        status: 'active'
                    })
                    .eq('id', id)

                if (error) throw error

                alert('–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ –º–µ—Å—è—Ü –¥–æ ' + formatDate(newExpiry.toISOString()))
                loadSubscriptions()
                loadStats()

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message)
            }
        }

        // –°–±—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function resetDevice(id) {
            if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.')) {
                return
            }

            try {
                const { error } = await supabase
                    .from('subscriptions')
                    .update({ device_fingerprint: null })
                    .eq('id', id)

                if (error) throw error

                alert('–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É —Å–±—Ä–æ—à–µ–Ω–∞')
                loadSubscriptions()

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message)
            }
        }

        // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        async function deactivateSubscription(id) {
            if (!confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return
            }

            try {
                const { error } = await supabase
                    .from('subscriptions')
                    .update({ status: 'inactive' })
                    .eq('id', id)

                if (error) throw error

                alert('–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞')
                loadSubscriptions()
                loadStats()

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message)
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        async function exportSubscriptions() {
            try {
                const csv = [
                    ['Email', 'License Key', 'Plan', 'Status', 'Created', 'Expires', 'Device'].join(','),
                    ...subscriptions.map(sub => [
                        sub.email,
                        sub.license_key,
                        sub.plan,
                        sub.status,
                        formatDate(sub.created_at),
                        formatDate(sub.expires_at),
                        sub.device_fingerprint || ''
                    ].join(','))
                ].join('\n')

                const blob = new Blob([csv], { type: 'text/csv' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `subscriptions-${new Date().toISOString().slice(0, 10)}.csv`
                a.click()
                URL.revokeObjectURL(url)

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message)
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
        async function cleanExpiredSubscriptions() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏—Å—Ç–µ–∫—à–∏–µ –±–æ–ª–µ–µ 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return
            }

            try {
                const cutoffDate = new Date()
                cutoffDate.setDate(cutoffDate.getDate() - 30)

                const { error } = await supabase
                    .from('subscriptions')
                    .delete()
                    .lt('expires_at', cutoffDate.toISOString())

                if (error) throw error

                alert('–°—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã')
                loadSubscriptions()
                loadStats()

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message)
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∑–∞–≥–ª—É—à–∫–∞)
        function sendNotifications() {
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏')
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        function generateLicenseKey() {
            const timestamp = Date.now().toString().slice(-6)
            const random = Math.random().toString(36).substr(2, 8).toUpperCase()
            return `FIGMA-${timestamp}-${random}`
        }

        function getPlanName(plan) {
            const plans = {
                'monthly': '–ú–µ—Å—è—á–Ω–∞—è',
                'quarterly': '–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è',
                'yearly': '–ì–æ–¥–æ–≤–∞—è'
            }
            return plans[plan] || plan
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            })
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
        }

        function showResult(element, message, type) {
            element.innerHTML = message
            element.className = type
            element.classList.remove('hidden')
            setTimeout(() => element.classList.add('hidden'), 5000)
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        document.getElementById('admin-key').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authenticate()
            }
        })

        // –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result')
            resultDiv.classList.remove('hidden')
            resultDiv.innerHTML = 'üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...'

            if (demoMode) {
                showResult(resultDiv, '‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω. Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.', 'error')
                return
            }

            try {
                // –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const response = await fetch(CONFIG.SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                    }
                })

                if (response.ok) {
                    // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–∞–±–ª–∏—Ü–µ
                    const tableTest = await supabase
                        .from('subscriptions')
                        .select('id')
                        .limit(1)

                    if (tableTest.error) {
                        showResult(resultDiv, `‚ùå –¢–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: ${tableTest.error.message}`, 'error')
                    } else {
                        showResult(resultDiv, '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!', 'success')
                    }
                } else {
                    showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${response.status} ${response.statusText}`, 'error')
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error')
            }
        }

        function showConfig() {
            const resultDiv = document.getElementById('connection-result')
            resultDiv.classList.remove('hidden')

            const configInfo = `
                <strong>–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong><br>
                ‚Ä¢ URL: ${CONFIG.SUPABASE_URL}<br>
                ‚Ä¢ API Key: ${CONFIG.SUPABASE_ANON_KEY.substring(0, 20)}...<br>
                ‚Ä¢ –ê–¥–º–∏–Ω –∫–ª—é—á: ${CONFIG.ADMIN_KEY}<br>
                ‚Ä¢ –î–µ–º–æ-—Ä–µ–∂–∏–º: ${demoMode ? '–î–∞' : '–ù–µ—Ç'}<br>
                ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–µ–Ω: ${isConfigured() ? '–î–∞' : '–ù–µ—Ç'}
            `
            showResult(resultDiv, configInfo, 'success')
        }

        function generateTestLicense() {
            const resultDiv = document.getElementById('connection-result')
            resultDiv.classList.remove('hidden')

            const timestamp = Date.now().toString().slice(-6)
            const random = Math.random().toString(36).substr(2, 8).toUpperCase()
            const testLicense = `TEST-${timestamp}-${random}`

            const licenseInfo = `
                <strong>–¢–µ—Å—Ç–æ–≤–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞:</strong><br>
                üìß Email: test@demo.com<br>
                üîë –ö–ª—é—á: <span style="background: #f0f0f0; padding: 2px 4px; font-family: monospace;">${testLicense}</span><br>
                ‚è∞ –°—Ä–æ–∫: 30 –¥–Ω–µ–π<br><br>
                <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞</small>
            `
            showResult(resultDiv, licenseInfo, 'success')

            console.log('Test license generated:', {
                email: 'test@demo.com',
                license_key: testLicense,
                expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            })
        }

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('üîß Figma Plugin Admin Panel v1.1')
        console.log('üîê –í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-–∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è')
        console.log('‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', { configured: isConfigured(), demoMode: CONFIG.DEMO_MODE })
    </script>
</body>
</html>
