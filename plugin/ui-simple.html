<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–≠–∫—Å–ø–æ—Ä—Ç –ø–æ —Å–µ–∫—Ü–∏—è–º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
      background: #2c2c2c;
      color: #ffffff;
      padding: 16px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid #404040;
    }

    .button {
      padding: 8px 16px;
      background: #0d99ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .button:hover {
      background: #0b7acc;
    }

    .subscription-screen {
      padding: 16px;
      background: #383838;
      border-radius: 6px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      border: 1px solid #555;
      border-radius: 4px;
      background: #444;
      color: white;
    }

    .error {
      background: #ff4444;
      color: white;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .success {
      background: #44ff44;
      color: black;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Bulk Export by Sections</h1>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <div id="subscriptionScreen" class="subscription-screen">
      <h2>–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:</p>

      <input type="email" id="emailInput" placeholder="Email">
      <input type="text" id="licenseInput" placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á">

      <button class="button" id="activateBtn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>

      <div id="subscriptionError" class="error" style="display: none;"></div>
      <div id="subscriptionSuccess" class="success" style="display: none;"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="mainInterface" style="display: none;">
      <h2>–ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!</h2>
      <button class="button" id="getSectionsBtn">–ù–∞–π—Ç–∏ —Å–µ–∫—Ü–∏–∏</button>
      <div id="sectionsInfo"></div>
      <button class="button" id="exportBtn" style="display: none;">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button class="button" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    console.log('üîå UI Script loaded');

    let hasActiveSubscription = false;

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const subscriptionScreen = document.getElementById('subscriptionScreen');
    const mainInterface = document.getElementById('mainInterface');
    const emailInput = document.getElementById('emailInput');
    const licenseInput = document.getElementById('licenseInput');
    const activateBtn = document.getElementById('activateBtn');
    const getSectionsBtn = document.getElementById('getSectionsBtn');
    const exportBtn = document.getElementById('exportBtn');
    const closeBtn = document.getElementById('closeBtn');
    const subscriptionError = document.getElementById('subscriptionError');
    const subscriptionSuccess = document.getElementById('subscriptionSuccess');
    const sectionsInfo = document.getElementById('sectionsInfo');

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function showError(message) {
      subscriptionError.textContent = message;
      subscriptionError.style.display = 'block';
      subscriptionSuccess.style.display = 'none';
    }

    function showSuccess(message) {
      subscriptionSuccess.textContent = message;
      subscriptionSuccess.style.display = 'block';
      subscriptionError.style.display = 'none';
    }

    function hideMessages() {
      subscriptionError.style.display = 'none';
      subscriptionSuccess.style.display = 'none';
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function showMainInterface() {
      subscriptionScreen.style.display = 'none';
      mainInterface.style.display = 'block';
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏
    function showSubscriptionScreen() {
      subscriptionScreen.style.display = 'block';
      mainInterface.style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    activateBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const license = licenseInput.value.trim();

      if (!email || !license) {
        showError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á');
        return;
      }

      activateBtn.disabled = true;
      activateBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
      hideMessages();

      parent.postMessage({
        pluginMessage: {
          type: 'subscription-verify',
          email: email,
          license_key: license
        }
      }, '*');
    });

    getSectionsBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'get-sections' }
      }, '*');
    });

    exportBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: {
          type: 'start-export',
          settings: {
            format: 'PNG',
            scale: 2,
            createZip: false
          }
        }
      }, '*');
    });

    closeBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { type: 'close-plugin' }
      }, '*');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      console.log('üì® UI received message:', msg.type);

      if (msg.type === 'subscription-status') {
        if (msg.active) {
          hasActiveSubscription = true;
          showMainInterface();
          showSuccess('–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞!');
        } else {
          hasActiveSubscription = false;
          showSubscriptionScreen();
        }
        return;
      }

      if (msg.type === 'subscription-success') {
        hasActiveSubscription = true;
        activateBtn.disabled = false;
        activateBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
        showSuccess('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
        setTimeout(() => {
          showMainInterface();
        }, 1500);
        return;
      }

      if (msg.type === 'subscription-error') {
        activateBtn.disabled = false;
        activateBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
        showError(msg.message);
        return;
      }

      if (msg.type === 'sections-found') {
        const count = msg.sections.length;
        sectionsInfo.innerHTML = `<p>–ù–∞–π–¥–µ–Ω–æ —Å–µ–∫—Ü–∏–π: ${count}</p>`;
        exportBtn.style.display = count > 0 ? 'block' : 'none';
        return;
      }

      if (msg.type === 'export-complete') {
        showSuccess('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!');
        return;
      }

      if (msg.type === 'export-error') {
        showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + msg.message);
        return;
      }
    };

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    emailInput.value = 'test@demo.com';
    licenseInput.value = 'TEST-FIGMA-2024-KEY1';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    parent.postMessage({
      pluginMessage: { type: 'subscription-check' }
    }, '*');

    console.log('‚úÖ UI initialized successfully');
  </script>
</body>
</html>
